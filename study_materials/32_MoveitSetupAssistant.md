# MoveIt Setup Assistant: Настройка робота для MoveIt

<p align="center">
    <img src=../assets/moveit/32_moveIt_setup_assistant_launch.png />
</p>

**MoveIt Setup Assistant (MSA)** — это графический интерфейс, предназначенный для конфигурации роботов, которые вы планируете использовать с MoveIt. Этот инструмент автоматизирует процесс создания файлов конфигурации для вашего робота, включая:

1. **Формат описания семантического робота (SRDF)**: Основной файл, определяющий свойства и возможности робота, такие как группировки суставов и планируемые области работы.
2. **Дополнительные файлы конфигурации**: Все необходимые данные для интеграции робота с конвейером MoveIt.

Если вы хотите узнать больше о семантическом описании робота и URDF, посетите [обзор URDF/SRDF](https://moveit.github.io/moveit_tutorials/doc/urdf_srdf/urdf_srdf_tutorial.html). 

## Шаг 1. Запуск MoveIt Setup Assistant

Чтобы запустить **MoveIt Setup Assistant**, выполните следующую команду в терминале:

```bash
roslaunch moveit_setup_assistant setup_assistant.launch
```

После запуска откроется начальный экран с двумя опциями:

1. **Создать новый пакет конфигурации MoveIt**  
2. **Изменить существующий пакет конфигурации MoveIt**

Для создания новой конфигурации нажмите кнопку **Создать новый пакет конфигурации MoveIt**. После этого откроется следующий экран:

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_start.png" />
</p>

### Загрузка описания робота

1. Нажмите кнопку **Обзор** и перейдите к файлу описания робота в формате `URDF` (Unified Robot Description Format) в вашем пакете.  
2. Выберите файл и нажмите кнопку **Загрузить файлы**. 

Процесс загрузки файлов может занять несколько секунд. После успешной загрузки вы увидите следующий экран:

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_100.png" />
</p>

## Шаг 2: Генерация матрицы самостолкновений

Генератор матрицы самостолкновений в **MoveIt Setup Assistant** автоматически определяет пары звеньев робота, которые можно исключить из проверки столкновений, чтобы сократить время вычислений при планировании движения. Эти пары отключаются, если:

- Они всегда находятся в столкновении;
- Никогда не сталкиваются;
- Находятся в столкновении в положении робота по умолчанию;
- Находятся рядом друг с другом в кинематической цепи.

### Настройка плотности выборки

- **Плотность выборки** определяет количество случайных положений робота, проверяемых на самостолкновения.
- Более высокая плотность обеспечивает большую точность, но требует больше времени для вычислений.
- Рекомендуемое значение по умолчанию: **10 000 проверок столкновений**.

Проверка столкновений выполняется параллельно для ускорения процесса.

---

### Процесс генерации матрицы самостолкновений

1. Включите опцию **Matrix View**, чтобы просмотреть текущие пары звеньев.  
2. Выберите пары звеньев, которые никогда не могут быть в столкновении.  
3. Нажмите кнопку **Generate Collision Matrix**, чтобы запустить процесс генерации.  

> **Примечание:** Матрица заполняется автоматически, однако рекомендуется вручную проверить результаты, чтобы уточнить выбор (например, исключить лишние звенья из расчетов).

---

#### Пример результата

До генерации матрицы самостолкновений:  
<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_self_collisions.png" />
</p>

После генерации:  
<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_self_collisions_done.png" />
</p> 

**Важно:** Автоматическая генерация матрицы может быть неидеальной, поэтому ее результаты лучше уточнять вручную, чтобы повысить точность и оптимизировать вычисления.

## Шаг 3: Добавление виртуальных сочленений

**Виртуальные сочленения** используются для присоединения робота к мировой системе координат. Они представляют собой абстракцию, позволяющую указать, как робот взаимодействует с окружающим миром. В данном примере мы создадим одно виртуальное сочленение, которое соединяет `base_link` робота с мировой системой координат `world`. Это будет фиксированное сочленение, описывающее положение робота относительно мира.

---

### Процесс добавления виртуального сочленения

1. Перейдите на вкладку **Virtual Joints**.  
2. Нажмите кнопку **Add Virtual Joint**.  
3. Укажите следующие параметры:  
   - **Имя сочленения**: `virtual_joint`.  
   - **Дочерняя ссылка**: `base_link`.  
   - **Родительская система координат**: `world`.  
   - **Тип сочленения**: `fixed`.  

4. Нажмите кнопку **Save**, чтобы сохранить изменения.  

После выполнения этих действий вы увидите следующий экран:

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_virtual_joints.png" />
</p> 

---

**Примечание:** Виртуальные сочленения упрощают интеграцию робота в глобальную систему координат, определяя способ его связи с внешним миром. В данном случае фиксированное сочленение описывает статичное положение основания робота.

## Шаг 4: Добавление групп планирования

Группы планирования используются для определения семантических частей робота, таких как рука или конечный эффектор. Эти группы необходимы для настройки MoveIt, чтобы он мог планировать движение различных частей робота.

---

### Добавление группы планирования для руки

1. Перейдите на вкладку **Planning Groups**.  
2. Нажмите кнопку **Add Group**, чтобы открыть экран настройки групп.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_planning_groups.png" />
   </p>
3. Введите настройки для группы руки:
   - **Group Name**: `robot_arm`.  
   - **Kinematic Solver**: выберите `kdl_kinematics_plugin/KDLKinematicsPlugin`.  
   - Оставьте значения **Search Resolution** и **Kin. Search Timeout** по умолчанию.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_arm.png" />
   </p>
4. Добавьте сочленения:
   - Нажмите **Add Joints**.  
   - В списке слева выберите все сочленения, относящиеся к руке:
     - Для этого нажмите на `virtual_joint`, удерживайте клавишу `Shift`, затем выберите все сочленения руки.  
   - Нажмите кнопку **>**, чтобы переместить выбранные сочленения в список справа.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_arm_joints.png" />
   </p>
5. Нажмите **Save**, чтобы сохранить группу.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_arm_joints_saved.png" />
   </p>

---

### Добавление группы планирования для захвата (конечного эффектора)

1. Нажмите **Add Group** для добавления новой группы.  
2. Введите настройки для группы захвата:
   - **Group Name**: `robot_hand`.  
   - **Kinematic Solver**: оставьте значение по умолчанию `None`.  
   - Оставьте значения **Kin. Search Resolution** и **Kin. Search Timeout** по умолчанию.  
3. Добавьте звенья:
   - Нажмите **Add Links**.  
   - Выберите звенья `hand`, `leftfinger` и `rightfinger` в списке слева.  
   - Нажмите кнопку **>**, чтобы переместить их в список справа.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_planning_groups_gripper.png" />
   </p>
4. Нажмите **Save**, чтобы сохранить группу.

---

После выполнения этих шагов вы настроите две группы планирования: `robot_arm` для руки и `robot_hand` для захвата. Теперь MoveIt сможет работать с обеими частями робота при планировании движения.

## Шаг 5: Добавление поз робота

Добавление фиксированных поз помогает заранее определить удобные позиции робота, такие как положение "домой" или "готовность". Эти позы можно связать с конкретными группами планирования, чтобы использовать их при работе с MoveIt.

---

### Процесс добавления поз робота

1. Перейдите на вкладку **Robot Poses**.  
2. Нажмите кнопку **Add Pose**.  
3. Укажите имя для новой позы. Робот изначально окажется в **положении по умолчанию**, где значения сочленений устанавливаются на средний диапазон допустимых значений.  

### Настройка позы:

- Перемещайте отдельные сочленения робота, используя доступные ползунки или ввод значений вручную.  
- Когда вы будете удовлетворены положением, нажмите **Save**, чтобы сохранить позу.  

> Каждая поза привязывается к определенной группе планирования. Вы можете настроить уникальные позы для каждой группы.

---

### Полезные советы

- Используйте этот этап для проверки корректности границ сочленений, заданных в вашем URDF. Если вы заметите несоответствия или ошибки в пределах суставов, это будет сразу очевидно при перемещении ползунков.  
- Исправление этих проблем на данном этапе упростит дальнейшую настройку.

---

### Пример результата

После сохранения позы вы увидите ее в списке на экране:

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_saved_poses.png" />
</p> 

---

Добавленные позы робота будут использоваться в дальнейшем для быстрого перехода в предопределенные положения во время работы системы MoveIt.

## Шаг 6: Назначение конечных эффекторов

После добавления группы для захвата (руки робота) необходимо назначить ее как **конечный эффектор**. Это позволит выполнять специальные операции над этой частью робота, такие как манипуляции или захваты.

---

### Процесс назначения конечного эффектора

1. Перейдите на вкладку **End Effectors**.  
2. Нажмите кнопку **Add End Effector**.  
3. Укажите следующие параметры:  
   - **End Effector Name**: `hand`.  
   - **End Effector Group**: `hand`.  
   - **Parent Link**: `flance`.  
   - **Parent Group**: оставьте поле пустым.  

---

### Пример результата

После заполнения всех полей и сохранения конфигурации, вы увидите следующий экран:

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_end_effector_add.png" />
</p> 

---

## Примечания

- Назначение конечного эффектора помогает MoveIt определять, какие группы отвечают за захват и взаимодействие с объектами.  
- Убедитесь, что вы правильно указали **Parent Link**, чтобы конечный эффектор был корректно привязан к роботу.  

После этого шага конечный эффектор успешно интегрирован в конфигурацию робота.

## Шаг 7: Пассивные сочленения

Вкладка **Passive Joints** используется для указания пассивных сочленений, которые существуют в конструкции робота. Пассивные сочленения — это части робота, которыми невозможно управлять напрямую, например, ролики или неподвижные звенья. Указывая их, вы сообщаете планировщикам MoveIt, что эти сочленения не могут участвовать в кинематическом планировании.

Для данного робота **пассивных сочленений нет**, поэтому этот шаг можно пропустить.

## Шаг 8: Настройка 3D-восприятия

На вкладке **3D Perception** можно настроить параметры для 3D-датчиков, такие как лидары или камеры. Параметры конфигурации записываются в файл `sensors_3d.yaml`.

Мы не будем добавлять 3D-датчики в конфигурацию, поэтому пропустим этот шаг.

## Шаг 9: Настройка моделирования Gazebo

Вкладка **Simulation** позволяет настроить параметры для моделирования робота в симуляторе Gazebo. Здесь можно создать модифицированный URDF-файл, который будет совместим с Gazebo, добавив специфические параметры симуляции, такие как физические свойства звеньев или совместимость с плагинами Gazebo.

Для данного робота симуляция в Gazebo не требуется, поэтому этот шаг тоже можно пропустить.

## Шаг 10: Настройка управления ROS

**Управление ROS** — это набор пакетов, которые обеспечивают взаимодействие между контроллерами, аппаратными интерфейсами и кинематической моделью робота. MoveIt использует управление ROS для корректного управления суставами робота.

Для получения подробной информации ознакомьтесь с документацией: [ros_control](http://wiki.ros.org/ros_control).

---

### Процесс настройки управления ROS

1. Перейдите на вкладку **ROS Control**.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_ros_control.png" />
   </p>

2. Нажмите **Add Controller**, чтобы открыть экран добавления нового контроллера.  

3. Настройте контроллер для управления положением руки:
   - **Controller Name**: `arm_position_controller`.  
   - **Тип контроллера**: выберите `position_controllers/JointPositionController`.  

4. Добавьте сочленения к контроллеру:
   - Нажмите кнопку **Add Planning Group Joints**.  
   - Выберите группу планирования `robot_arm`, чтобы автоматически добавить все сочленения этой группы к контроллеру.  
   <p align="center">
      <img src="../assets/moveit/32_setup_assistant_panda_ros_control_add_joints.png" />
   </p>

5. Нажмите **Save**, чтобы сохранить настройки контроллера.  

---

### Пример результата

После настройки вы увидите конфигурацию контроллера на экране:  
<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_ros_control_create.png" />
</p>

---

## Зачем это нужно?

Настройка ROS Control позволяет MoveIt корректно управлять суставами вашего робота через ROS. Контроллеры определяют, какие интерфейсы и группы суставов будут задействованы, что делает управление роботом интуитивным и гибким.

## Шаг 11: Добавление информации об авторе

Перед завершением настройки необходимо указать информацию об авторе, так как это требуется системой **Catkin** для публикации пакета.

### Процесс:
1. Перейдите на вкладку **Author Information**.  
2. Укажите свое имя и адрес электронной почты.  
3. Сохраните изменения.

## Шаг 12: Генерация файлов конфигурации

Теперь, когда настройка завершена, осталось сгенерировать все необходимые файлы конфигурации для использования MoveIt.

### Процесс:
1. Перейдите на вкладку **Configuration Files**.  
2. Выберите место и имя для пакета ROS, который будет содержать ваши файлы конфигурации:
   - Нажмите **Browse**, выберите подходящее место (например, ваш домашний каталог).  
   - Создайте новую папку, назвав ее, например, `my_robot_moveit_config`, и нажмите **Choose**.  

3. Нажмите кнопку **Generate Package**.  

   Помощник MoveIt Setup Assistant создаст все файлы конфигурации и запишет их в выбранный каталог.  

4. Просмотрите сгенерированные файлы:
   - На вкладке **Generated Files/Folders** вы увидите все созданные файлы.  
   - Вы можете щелкнуть на любой из них, чтобы просмотреть описание их содержимого.  

<p align="center">
   <img src="../assets/moveit/32_setup_assistant_panda_done.png" />
</p>

---

## Поздравляем!

Теперь вы успешно сгенерировали файлы конфигурации для вашего робота. Эти файлы готовы к использованию с MoveIt.

---

## Что дальше?

После настройки рекомендуется начать работу с **MoveIt RViz Plugin**, чтобы проверить работу вашего робота и начать планирование движений. Вы можете следовать [руководству по быстрой настройке в RViz](33_RvizMoveit).

Используйте сгенерированные файлы конфигурации, чтобы интегрировать вашего робота в различные сценарии и улучшать его взаимодействие с MoveIt. Удачи! 🚀