# Быстрый старт с MoveIt в RViz

![RViz Plugin](../assets/moveit/33_rviz_plugin_head.png)

Этот туториал поможет вам быстро освоить планирование движений с использованием MoveIt через RViz и плагин MoveIt. **RViz** — это основной визуализатор в ROS, который является незаменимым инструментом для отладки робототехнических систем. Плагин MoveIt для RViz позволяет:

- Настраивать виртуальные сцены.
- Интерактивно задавать начальные и целевые состояния для робота.
- Тестировать различные планировщики движения.
- Визуализировать результаты.

Давайте начнем!

---

## Шаг 1: Запустите демо и настройте плагин

1. **Запустите демонстрацию:**

   ```bash
   roslaunch robot_moveit_config demo.launch use_rviz:=true
   ```

2. **Добавьте плагин Motion Planning** (если делаете это впервые):

   - Вы увидите пустой мир в RViz:

     ![Пустой RViz](../assets/moveit/33_rviz_empty.png)

   - В панели **Displays** нажмите кнопку **Add**:

     ![Добавление дисплея](../assets/moveit/33_rviz_click_add.png)

   - Из папки `moveit_ros_visualization` выберите **MotionPlanning** в качестве типа дисплея. Нажмите **Ok**.

     ![Добавление плагина Motion Planning](../assets/moveit/33_rviz_plugin_motion_planning_add.png)

   - После этого вы увидите робота в RViz:

     ![Робот в RViz](../assets/moveit/33_rviz_start.png)

3. **Настройте плагин Motion Planning**:

   - В вкладке **Global Options** под панелью **Displays** установите поле **Fixed Frame** в значение `/base_link`.

4. **Настройте плагин для робота**:

   - В панели **Displays** выберите **MotionPlanning**.
   - Убедитесь, что поле **Robot Description** установлено в значение `robot_description`.
   - Проверьте, что поле **Planning Scene Topic** установлено в `move_group/monitored_planning_scene`. (Для смены топика нажмите на его название, чтобы открыть выпадающий список.)
   - Убедитесь, что **Trajectory Topic** в разделе **Planned Path** установлено в `/move_group/display_planned_path`.
   - В разделе **Planning Request** измените поле **Planning Group** на `robot_arm`. Это также можно увидеть в панели MotionPlanning внизу слева.

---

![Начало работы с плагином](../assets/moveit/33_rviz_plugin_start.png)

## Шаг 2: Работа с визуализацией робота

В RViz доступны четыре различных типа визуализации, которые могут пересекаться друг с другом:

1. **Конфигурация робота** в среде планирования ``move_group/monitored_planning_scene`` (включена по умолчанию).  
2. **Запланированный путь для робота** (включен по умолчанию).  
3. **Начальное состояние для планирования движений** (выделено зеленым цветом, отключено по умолчанию).  
4. **Целевое состояние для планирования движений** (выделено оранжевым цветом, включено по умолчанию).  

#### Управление отображением

Состояния визуализаций можно включать и выключать, используя следующие чекбоксы:

- **Планировочная сцена робота**: чекбокс **Show Robot Visual** на вкладке **Scene Robot**.  
- **Запланированный путь**: чекбокс **Show Robot Visual** на вкладке **Planned Path**.  
- **Начальное состояние**: чекбокс **Query Start State** на вкладке **Planning Request**.  
- **Целевое состояние**: чекбокс **Query Goal State** на вкладке **Planning Request**.  

### Эксперимент

Попробуйте включать и выключать разные чекбоксы, чтобы переключаться между различными визуализациями.

---

![Визуализация роботов в RViz](../assets/moveit/33_rviz_plugin_visualize_robots.png)

## Шаг 3: Взаимодействие с роботом

Для следующих шагов убедитесь, что отображаются только сцена робота, начальное и целевое состояния:

1. Включите чекбокс **Show Robot Visual** на вкладке **Planned Path**.  
2. Отключите чекбокс **Show Robot Visual** на вкладке **Scene Robot**.  
3. Включите чекбокс **Query Goal State** на вкладке **Planning Request**.  
4. Включите чекбокс **Query Start State** на вкладке **Planning Request**.  

Теперь вы должны увидеть два интерактивных маркера:  
- **Оранжевый маркер** — используется для задания "Целевого состояния".  
- **Зеленый маркер** — используется для задания "Начального состояния".  

Если маркеры не отображаются, нажмите кнопку **Interact** в верхнем меню RViz. Если инструмент **Interact** отсутствует, добавьте его, нажав **"+"** в верхнем меню.

---

![Интерактивные маркеры в RViz](../assets/moveit/33_rviz_plugin_interact.png)

Теперь вы можете использовать эти маркеры, чтобы перемещать руку робота и изменять ее ориентацию. Попробуйте!

---

## Перемещение в столкновение

Попробуйте переместить одну из рук так, чтобы она столкнулась с другой. Звенья, которые находятся в столкновении, будут окрашены в красный цвет.

![Столкновение звеньев](../assets/moveit/33_rviz_plugin_collision.png)

Чекбокс **Use Collision-Aware IK**, расположенный во вкладке **Planning** плагина MotionPlanning, позволяет переключать поведение решателя обратной кинематики (IK).  
- Когда чекбокс включен, решатель будет пытаться найти решение без столкновений.  
- Когда чекбокс выключен, решатель допускает столкновения.  

Однако звенья, находящиеся в столкновении, всегда визуализируются красным цветом, независимо от состояния чекбокса.

![Чекбокс для Collision-Aware IK](../assets/moveit/33_rviz_plugin_collision_aware_ik_checkbox.png)

---

## Перемещение вне досягаемости

Попробуйте переместить конечный эффектор за пределы рабочей области. Робот не сможет дотянуться до заданного положения.

![Конечный эффектор вне рабочей области](../assets/moveit/33_rviz_plugin_invalid.png)

---

## Шаг 4: Использование планирования движения

Теперь вы можете начать планировать движение для робота с помощью плагина MoveIt в RViz:

1. Переместите **Начальное состояние** в желаемую позицию.  
2. Переместите **Целевое состояние** в другую желаемую позицию.  
3. Убедитесь, что оба состояния не находятся в столкновении с самим роботом.  
4. Убедитесь, что **Planned Path** визуализируется. Включите чекбокс **Show Trail** на вкладке **Planned Path**.  

### Планирование

В окне **MotionPlanning** во вкладке **Planning** нажмите кнопку **Plan**. Вы должны увидеть визуализацию движения руки робота и траекторию.

![Визуализация запланированного пути](../assets/moveit/33_rviz_plugin_planned_path.png)

---

## Выбор конкретных начальных/целевых состояний

Во вкладке **Planning** можно выбирать начальные и целевые состояния из следующих опций:
- Текущее состояние.
- Предыдущее состояние.
- Случайное состояние.
- Предопределенное состояние, указанное в файле ``.srdf`` робота.

**Предыдущее состояние** ссылается на начальное состояние предыдущей попытки планирования. Это позволяет легко вернуться к предыдущей позе робота. После выполнения движения **текущее** и **предыдущее** состояния автоматически обновляются, что упрощает переключение между двумя состояниями.

![Доступ к предыдущему состоянию](../assets/moveit/33_rviz_plugin_access_previous_pose.gif)

---

## Инспекция точек траектории

Вы можете визуально просматривать траектории, точка за точкой:

1. В меню **Panels** выберите **MotionPlanning - Slider**. Новая панель **Slider** появится в RViz.  
2. Задайте целевую позу, затем нажмите **Plan**.  
3. Используйте панель **Slider** для управления траекторией: двигайте ползунок или нажмите кнопку **Play**.

> **Примечание:** После перемещения конечного эффектора к новой цели обязательно нажмите **Plan** перед запуском **Play**, иначе вы увидите траекторию для предыдущей цели.

![Панель Slider для просмотра траекторий](../assets/moveit/33_rviz_plugin_slider.png)

---

## Планирование по декартовым траекториям

Если активирован чекбокс **Use Cartesian Path**, робот будет пытаться перемещать конечный эффектор линейно в декартовом пространстве.

- Планирование свободного пути:  
  ![Планирование свободного пути](../assets/moveit/33_rviz_plan_free.png)

- Планирование декартового пути:  
  ![Планирование декартового пути](../assets/moveit/33_rviz_plan_cartesian.png)

---

## Выполнение траекторий и настройка скорости

Нажатие кнопок **Plan & Execute** или **Execute** после успешного планирования отправляет траекторию роботу. В данном случае, поскольку используется `demo.launch`, робот только симулируется.

По умолчанию масштаб скорости и ускорения установлен на 10% (`0.1`) от максимального значения робота. Вы можете изменить эти параметры:
- Во вкладке **Planning** в RViz.  
- В файле конфигурации робота `joint_limits.yaml` в пакете `moveit_config`.

![Настройка параметров скорости](../assets/moveit/33_rviz_plugin_collision_aware_ik_checkbox.png)

---

## Следующие шаги

### RViz Visual Tools

Многие уроки используют пакет **moveit_visual_tools** для пошагового выполнения демонстраций. Перед продолжением рекомендуется включить панель **RvizVisualToolsGui**.

1. В меню **Panels** выберите **RvizVisualToolsGui**.  
2. Новая панель будет добавлена в RViz.

![Добавление панели RViz Visual Tools](../assets/moveit/33_rviz_panels.png)

---

### Сохранение конфигурации

Сохраните вашу конфигурацию в RViz через **File -> Save Config**, чтобы использовать ее в последующих уроках.

---

## Последующие уроки

- **Контроль робота на Python:** ознакомьтесь с [Move Group Python Interface](../move_group_python_interface/move_group_python_interface_tutorial.
